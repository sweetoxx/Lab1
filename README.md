**Асташов Иван 3131**
# Отчет по лабораторной работе №1
---
[Ссылка на github](https://github.com/sweetoxx/Lab1)
## По курсу "Основы программирования"
## Текст задания

**Цель работы** - спроектировать и разработать систему авторизации пользователей на протоколе HTTP. Выполненные требования:

* функциональность входа/выхода,
* хранение паролей в хешированном виде,
* форма регистрации.

### Пользовательский интерфейс  
 1.Страница регистрации
![a](https://github.com/sweetoxx/Lab1/blob/main/registration.png)
 2.Страница входа
![a](https://github.com/sweetoxx/Lab1/blob/main/autorization.png)
 3.Основная страница сайта
![a](https://github.com/sweetoxx/Lab1/blob/main/mainpage.png)
 Доступ к главной странице не доступен для пользователей которые не выполнили вход в аккаунт. Так же страница входа и регистрации недоступна для пользователей которые уже выполнили вход.
## Пользовательские сценарии работы
 * Пользователь вводит в адресной строке signup.php и попадает на форму регистрации. Вводит данные, но пользователь с таким именем уже зарегистрирован - на экране появляется сообщение "Username already taken!". Тогда, при регистрации с другим ником, пользователь переходит на страницу входа и после повторного ввода данных попадает на сайт.
* Пользователь вводит в адресной строке signin.php и попадает на форму входа. Вводит данные, но неверно - появляется сообщение "Wrong login or password!". Пользователь повторн вводит данные и успешно попадает на сайт.
* Пользователь вводит в адресной строке index.php и оказывается перенаправлен на страницу со входом. Вводит свои верные данные и попадает на сайт.
## Описание API сервера и его хореографии
Сервер использует HTTP GET запросы с полями user_name (логин) и password (пароль). Также, сервер использует куки auth_token - токен авторизации.
* Алгоритм входа на сайт - отправляется запрос, который возвращает данные о пользователе с отправленным логином, если данные найдены - пароль сверяется с захешированным из базы данных и совершается вход. В ином случае на экране пользователь видит сообщение "Wrong login or password!" - неправильные логин или пароль. Если данные о пользователе с данным логином не были найдены вообще - появляется текст "Please enter some valid information!" - пожалуйста, введите достоверную информацию.
* Алгоритм регистрации на сайте - принимаются все введённые пользователем данные, а также генерируются соль и хеш пароля, далее отправляется запрос, который проверяет, нет ли уже пользователя с таким именем в базе данных. Если пользователь оставил одно из полей логин/пароль пустым, появляется сообщение "Please enter some valid information!" - пожалуйста, введите достоверную информацию. При условии, что пользователь с подобным логином не был найден в базе данных, серверу отправляется запрос и пользователь заносится в базу данных, после чего попадает на страницу входа. Если пользователь с этим логином в базе данных есть - выскакивает сообщение "Username already taken!" - имя пользователя уже занято.
* Функция аутентификации пользователя - по запросу серверу возвращается токен аутентификации, соответствующий пользователю с токеном, используемым в браузере. Если совпадение найдено - переход на главную страницу разрешён, в ином случае пользователь возвращается на страницу входа для повторной авторизации.
## Описание страктуры базы данных
Для администрирования сервера MySQL и просмотра содержимого базы данных используется браузерное приложение phpMyAdmin. Используется 4 столбца:
* "id" типа int с автоматическим приращением для выдачи уникальных id каждому зарегистрированному пользователю,
* "user_name" типа varchar для хранения логина пользователя,
* "auth_token" типа bigint для хранения значения токена этого пользователя (значения кукис),
* "password" типа varchar для хранения пароля пользователя в хешированном виде,

 ## Описание алгоритмов
 1. Алгоритм регистрации на сайте.
 
![a](https://github.com/sweetoxx/Lab1/blob/main/registerscheme.png)

2. Алгоритм входа на сайт.
 
![a](https://github.com/sweetoxx/Lab1/blob/main/autorizscheme.png)
## Примеры HTTP запросов/ответов
![a](https://github.com/sweetoxx/Lab1/blob/main/cluentserverscheme.png)

 ## Значимые фрагменты кода
 **Регистрация пользователя**
```php
$full_name = $_POST['full_name'];
    $login = $_POST['login'];
    $email = $_POST['email'];
    $password = $_POST['password'];
    $password_confirm = $_POST['password_confirm'];

    if ($password === $password_confirm) {

        $path = 'uploads/' . time() . $_FILES['avatar']['name'];
        if (!move_uploaded_file($_FILES['avatar']['tmp_name'], '../' . $path)) {
            $_SESSION['message'] = 'Ошибка при загрузке сообщения';
            header('Location: ../register.php');
        }

        $password = md5($password);

        mysqli_query($connect, "INSERT INTO `users` (`id`, `full_name`, `login`, `email`, `password`, `avatar`) VALUES (NULL, '$full_name', '$login', '$email', '$password', '$path')");

        $_SESSION['message'] = 'Регистрация прошла успешно!';
        header('Location: ../index.php');


    } else {
        $_SESSION['message'] = 'Пароли не совпадают';
        header('Location: ../register.php');
    }
```
**Авторизация пользователя**
```php
     $login = $_POST['login'];
    $password = md5($_POST['password']);

    $check_user = mysqli_query($connect, "SELECT * FROM `users` WHERE `login` = '$login' AND `password` = '$password'");
    if (mysqli_num_rows($check_user) > 0) {

        $user = mysqli_fetch_assoc($check_user);

        $_SESSION['user'] = [
            "id" => $user['id'],
            "full_name" => $user['full_name'],
            "avatar" => $user['avatar'],
            "email" => $user['email']
        ];

        header('Location: ../profile.php');

    } else {
        $_SESSION['message'] = 'Не верный логин или пароль';
        header('Location: ../index.php');
    }
 ```
